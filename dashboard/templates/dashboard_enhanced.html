{% extends "base.html" %}

{% block title %}Real-Time Dashboard | Smart Farming Drones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* Enhanced Dashboard Styles */
    .dashboard-container {
        padding: 20px 0;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    /* Real-Time Status Banner */
    .status-banner {
        background: linear-gradient(135deg, #10b981, #14b8a6);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .status-banner h2 {
        margin: 0 0 10px 0;
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
    }
    
    .pulse-dot {
        width: 10px;
        height: 10px;
        background: #ff4444;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    /* Health Status Cards */
    .health-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .health-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        border: 2px solid;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .health-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .health-card.healthy {
        border-color: #10b981;
    }
    
    .health-card.healthy::before {
        background: #10b981;
    }
    
    .health-card.borderline {
        border-color: #f59e0b;
    }
    
    .health-card.borderline::before {
        background: #f59e0b;
    }
    
    .health-card.diseased {
        border-color: #ef4444;
    }
    
    .health-card.diseased::before {
        background: #ef4444;
    }
    
    .health-card.critical {
        border-color: #dc2626;
        animation: criticalPulse 2s infinite;
    }
    
    .health-card.critical::before {
        background: #dc2626;
    }
    
    @keyframes criticalPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
        50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
    }
    
    .health-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        font-size: 28px;
    }
    
    .health-card.healthy .health-card-icon {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .health-card.borderline .health-card-icon {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }
    
    .health-card.diseased .health-card-icon {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .health-card.critical .health-card-icon {
        background: rgba(220, 38, 38, 0.1);
        color: #dc2626;
    }
    
    .health-card-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .health-card-label {
        color: var(--muted);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .health-card-percentage {
        font-size: 1.1rem;
        margin-top: 12px;
        opacity: 0.8;
    }
    
    /* Spray Priority Section */
    .spray-priority-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 30px;
    }
    
    .spray-priority-section h3 {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .priority-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .priority-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .priority-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateX(5px);
    }
    
    .priority-item.critical {
        border-left-color: #dc2626;
    }
    
    .priority-item.high {
        border-left-color: #ef4444;
    }
    
    .priority-item.medium {
        border-left-color: #f59e0b;
    }
    
    .priority-item.low {
        border-left-color: #10b981;
    }
    
    .priority-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .priority-badge.critical {
        background: rgba(220, 38, 38, 0.2);
        color: #dc2626;
    }
    
    .priority-badge.high {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .priority-badge.medium {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    .priority-badge.low {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    /* Camera Integration Section */
    .camera-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 30px;
    }
    
    .camera-preview {
        width: 100%;
        height: 400px;
        background: #000;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    #cameraFeed {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .camera-placeholder {
        color: var(--muted);
        text-align: center;
    }
    
    .camera-controls {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        flex-wrap: wrap;
    }
    
    .camera-controls button {
        flex: 1;
        min-width: 150px;
    }
    
    /* Real-Time Scan Results */
    .scan-results {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 30px;
    }
    
    .scan-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }
    
    .scan-item {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .scan-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateY(-2px);
    }
    
    .scan-item.healthy-zone {
        border-color: #10b981;
    }
    
    .scan-item.borderline-zone {
        border-color: #f59e0b;
    }
    
    .scan-item.diseased-zone {
        border-color: #ef4444;
    }
    
    .scan-item.critical-zone {
        border-color: #dc2626;
        animation: criticalZone 2s infinite;
    }
    
    @keyframes criticalZone {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .zone-number {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .zone-status {
        font-size: 0.85rem;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .zone-ndvi {
        font-size: 0.9rem;
        color: var(--muted);
    }
    
    .spray-indicator {
        margin-top: 8px;
        padding: 4px 8px;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* Analytics Charts */
    .charts-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 24px;
    }
    
    .chart-card h4 {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .health-status-grid {
            grid-template-columns: 1fr;
        }
        
        .charts-row {
            grid-template-columns: 1fr;
        }
        
        .camera-controls {
            flex-direction: column;
        }
        
        .camera-controls button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container container">
    <!-- Real-Time Crop Status Banner -->
    <div class="status-banner" id="cropStatusBanner" style="background: linear-gradient(135deg, #10b981, #14b8a6);">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="mb-2">ðŸŒ¾ Real-Time Crop Status</h2>
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div style="font-size: 2rem; font-weight: 700;" id="overallStatus">
                        SCANNING...
                    </div>
                    <div class="live-indicator">
                        <span class="pulse-dot"></span>
                        <span>LIVE</span>
                    </div>
                </div>
                <p class="mb-0 mt-2" id="statusMessage" style="font-size: 1.1rem;">Analyzing field conditions...</p>
            </div>
            <div class="col-md-6">
                <div class="row text-center">
                    <div class="col-4">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700;" id="goodPercentage">0%</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Good Crops</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700;" id="badPercentage">0%</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Need Attention</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700;" id="sprayPercentage">0%</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Need Spray</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Status Overview -->
    <div class="health-status-grid">
        <div class="health-card healthy">
            <div class="health-card-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="health-card-value" id="healthyCount">0</div>
            <div class="health-card-label">Healthy Zones</div>
            <div class="health-card-percentage" id="healthyPercent">0%</div>
        </div>

        <div class="health-card borderline">
            <div class="health-card-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="health-card-value" id="borderlineCount">0</div>
            <div class="health-card-label">Borderline</div>
            <div class="health-card-percentage" id="borderlinePercent">0%</div>
        </div>

        <div class="health-card diseased">
            <div class="health-card-icon">
                <i class="fas fa-disease"></i>
            </div>
            <div class="health-card-value" id="diseasedCount">0</div>
            <div class="health-card-label">Diseased</div>
            <div class="health-card-percentage" id="diseasedPercent">0%</div>
        </div>

        <div class="health-card critical">
            <div class="health-card-icon">
                <i class="fas fa-skull-crossbones"></i>
            </div>
            <div class="health-card-value" id="criticalCount">0</div>
            <div class="health-card-label">Critical</div>
            <div class="health-card-percentage" id="criticalPercent">0%</div>
        </div>
    </div>

    <!-- Spray Priority Section -->
    <div class="spray-priority-section">
        <h3>
            <i class="fas fa-spray-can"></i>
            Spray Priority Queue
        </h3>
        <div class="priority-list" id="sprayPriorityList">
            <p class="text-muted">No zones requiring spray at the moment</p>
        </div>
    </div>

    <!-- Camera Integration -->
    <div class="camera-section">
        <h3 class="mb-3">
            <i class="fas fa-camera"></i>
            Live Camera Feed
        </h3>
        <div class="camera-preview" id="cameraPreview">
            <div class="camera-placeholder">
                <i class="fas fa-camera fa-3x mb-3"></i>
                <p>Camera not started</p>
            </div>
            <video id="cameraFeed" style="display: none;" autoplay playsinline></video>
            <canvas id="captureCanvas" style="display: none;"></canvas>
        </div>
        <div class="camera-controls">
            <button class="btn btn-primary" id="startCamera">
                <i class="fas fa-video"></i> Start Camera
            </button>
            <button class="btn btn-success" id="captureImage" disabled>
                <i class="fas fa-camera"></i> Capture & Analyze
            </button>
            <button class="btn btn-secondary" id="uploadImage">
                <i class="fas fa-upload"></i> Upload Image
            </button>
            <button class="btn btn-danger" id="stopCamera" disabled>
                <i class="fas fa-stop"></i> Stop Camera
            </button>
        </div>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
    </div>

    <!-- Real-Time Scan Results -->
    <div class="scan-results">
        <h3 class="mb-3">
            <i class="fas fa-chart-bar"></i>
            Real-Time Scan Data
        </h3>
        <div class="scan-grid" id="scanGrid">
            <p class="text-muted">No scan data available. Start scanning to see results.</p>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div class="charts-row">
        <div class="chart-card">
            <h4>
                <i class="fas fa-chart-pie"></i>
                Health Distribution
            </h4>
            <canvas id="healthPieChart"></canvas>
        </div>

        <div class="chart-card">
            <h4>
                <i class="fas fa-chart-line"></i>
                NDVI Trend
            </h4>
            <canvas id="ndviLineChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Real-Time Dashboard JavaScript
    let cameraStream = null;
    let healthPieChart = null;
    let ndviLineChart = null;
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        loadRealTimeData();
        setInterval(loadRealTimeData, 5000); // Update every 5 seconds
    });
    
    // Initialize Charts
    function initializeCharts() {
        // Health Distribution Pie Chart
        const pieCtx = document.getElementById('healthPieChart').getContext('2d');
        healthPieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Healthy', 'Borderline', 'Diseased', 'Critical'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#dc2626'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e9ecef'
                        }
                    }
                }
            }
        });
        
        // NDVI Trend Line Chart
        const lineCtx = document.getElementById('ndviLineChart').getContext('2d');
        ndviLineChart = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Average NDVI',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#e9ecef'
                        }
                    }
                }
            }
        });
    }
    
    // Load Real-Time Data
    function loadRealTimeData() {
        // Load crop status
        fetch('/api/crop_status')
            .then(response => response.json())
            .then(data => {
                updateCropStatus(data);
            })
            .catch(error => console.error('Error loading crop status:', error));
        
        // Load field data
        fetch('/api/field_data')
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    updateHealthStatus(data);
                    updateSprayPriority(data);
                    updateScanGrid(data);
                    updateCharts(data);
                }
            })
            .catch(error => console.error('Error loading data:', error));
    }
    
    // Update Crop Status Banner
    function updateCropStatus(data) {
        const banner = document.getElementById('cropStatusBanner');
        const statusEl = document.getElementById('overallStatus');
        const messageEl = document.getElementById('statusMessage');
        const goodPctEl = document.getElementById('goodPercentage');
        const badPctEl = document.getElementById('badPercentage');
        const sprayPctEl = document.getElementById('sprayPercentage');
        
        statusEl.textContent = data.status || 'SCANNING...';
        messageEl.textContent = data.message || 'Analyzing field conditions...';
        goodPctEl.textContent = (data.good_percentage || 0) + '%';
        badPctEl.textContent = (data.bad_percentage || 0) + '%';
        sprayPctEl.textContent = (data.spray_percentage || 0) + '%';
        
        // Change banner color based on status
        if (data.status === 'GOOD') {
            banner.style.background = 'linear-gradient(135deg, #10b981, #14b8a6)';
        } else if (data.status === 'MODERATE') {
            banner.style.background = 'linear-gradient(135deg, #f59e0b, #f97316)';
        } else if (data.status === 'NOT GOOD') {
            banner.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        }
    }
    
    // Update Health Status Cards
    function updateHealthStatus(zones) {
        const healthy = zones.filter(z => z.health_status === 'healthy').length;
        const borderline = zones.filter(z => z.health_status === 'borderline').length;
        const diseased = zones.filter(z => z.health_status === 'diseased').length;
        const critical = zones.filter(z => z.health_status === 'critical').length;
        const total = zones.length;
        
        document.getElementById('healthyCount').textContent = healthy;
        document.getElementById('borderlineCount').textContent = borderline;
        document.getElementById('diseasedCount').textContent = diseased;
        document.getElementById('criticalCount').textContent = critical;
        
        document.getElementById('healthyPercent').textContent = 
            `${total > 0 ? ((healthy / total) * 100).toFixed(1) : 0}%`;
        document.getElementById('borderlinePercent').textContent = 
            `${total > 0 ? ((borderline / total) * 100).toFixed(1) : 0}%`;
        document.getElementById('diseasedPercent').textContent = 
            `${total > 0 ? ((diseased / total) * 100).toFixed(1) : 0}%`;
        document.getElementById('criticalPercent').textContent = 
            `${total > 0 ? ((critical / total) * 100).toFixed(1) : 0}%`;
    }
    
    // Update Spray Priority List
    function updateSprayPriority(zones) {
        const needsSpray = zones.filter(z => 
            z.health_status === 'diseased' || z.health_status === 'critical'
        );
        
        const container = document.getElementById('sprayPriorityList');
        
        if (needsSpray.length === 0) {
            container.innerHTML = '<p class="text-muted">No zones requiring spray at the moment</p>';
            return;
        }
        
        // Sort by priority
        needsSpray.sort((a, b) => {
            const priority = { critical: 4, diseased: 3, borderline: 2, healthy: 1 };
            return priority[b.health_status] - priority[a.health_status];
        });
        
        container.innerHTML = needsSpray.slice(0, 5).map(zone => {
            const priority = zone.health_status === 'critical' ? 'critical' : 'high';
            const amount = zone.health_status === 'critical' ? '3L/ha' : '2L/ha';
            
            return `
                <div class="priority-item ${priority}">
                    <div>
                        <strong>Zone ${zone.zone_id}</strong>
                        <div><small class="text-muted">NDVI: ${zone.ndvi_value.toFixed(2)} | Status: ${zone.health_status}</small></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="priority-badge ${priority}">${priority}</span>
                        <span>${amount}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Update Scan Grid
    function updateScanGrid(zones) {
        const container = document.getElementById('scanGrid');
        
        if (zones.length === 0) {
            container.innerHTML = '<p class="text-muted">No scan data available</p>';
            return;
        }
        
        container.innerHTML = zones.slice(0, 12).map(zone => {
            const statusClass = zone.health_status === 'healthy' ? 'healthy-zone' :
                              zone.health_status === 'borderline' ? 'borderline-zone' :
                              zone.health_status === 'diseased' ? 'diseased-zone' : 'critical-zone';
            
            const needsSpray = zone.health_status === 'diseased' || zone.health_status === 'critical';
            
            return `
                <div class="scan-item ${statusClass}">
                    <div class="zone-number">${zone.zone_id}</div>
                    <div class="zone-status">${zone.health_status}</div>
                    <div class="zone-ndvi">NDVI: ${zone.ndvi_value.toFixed(2)}</div>
                    ${needsSpray ? '<div class="spray-indicator">ðŸ”´ Spray Required</div>' : ''}
                </div>
            `;
        }).join('');
    }
    
    // Update Charts
    function updateCharts(zones) {
        const healthy = zones.filter(z => z.health_status === 'healthy').length;
        const borderline = zones.filter(z => z.health_status === 'borderline').length;
        const diseased = zones.filter(z => z.health_status === 'diseased').length;
        const critical = zones.filter(z => z.health_status === 'critical').length;
        
        // Update pie chart
        healthPieChart.data.datasets[0].data = [healthy, borderline, diseased, critical];
        healthPieChart.update();
        
        // Update NDVI line chart
        const avgNDVI = zones.reduce((sum, z) => sum + z.ndvi_value, 0) / zones.length;
        const now = new Date().toLocaleTimeString();
        
        ndviLineChart.data.labels.push(now);
        ndviLineChart.data.datasets[0].data.push(avgNDVI);
        
        // Keep last 10 points
        if (ndviLineChart.data.labels.length > 10) {
            ndviLineChart.data.labels.shift();
            ndviLineChart.data.datasets[0].data.shift();
        }
        
        ndviLineChart.update();
    }
    
    // Camera Functions
    document.getElementById('startCamera').addEventListener('click', async function() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 1280, height: 720 } 
            });
            
            const video = document.getElementById('cameraFeed');
            video.srcObject = cameraStream;
            video.style.display = 'block';
            document.querySelector('.camera-placeholder').style.display = 'none';
            
            this.disabled = true;
            document.getElementById('captureImage').disabled = false;
            document.getElementById('stopCamera').disabled = false;
            
            showToast('Camera Started', 'Camera is now active', 'success');
        } catch (error) {
            showToast('Camera Error', 'Failed to access camera: ' + error.message, 'error');
        }
    });
    
    document.getElementById('captureImage').addEventListener('click', function() {
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('captureCanvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'capture.jpg');
            
            fetch('/api/analyze_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showToast('Analysis Complete', 'Image analyzed successfully', 'success');
                loadRealTimeData(); // Refresh data
            })
            .catch(error => {
                showToast('Analysis Failed', 'Error analyzing image', 'error');
            });
        }, 'image/jpeg');
    });
    
    document.getElementById('stopCamera').addEventListener('click', function() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            document.getElementById('cameraFeed').style.display = 'none';
            document.querySelector('.camera-placeholder').style.display = 'flex';
            
            document.getElementById('startCamera').disabled = false;
            document.getElementById('captureImage').disabled = true;
            this.disabled = true;
        }
    });
    
    document.getElementById('uploadImage').addEventListener('click', function() {
        document.getElementById('imageUpload').click();
    });
    
    document.getElementById('imageUpload').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const formData = new FormData();
            formData.append('image', e.target.files[0]);
            
            fetch('/api/analyze_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showToast('Upload Complete', 'Image uploaded and analyzed', 'success');
                loadRealTimeData();
            })
            .catch(error => {
                showToast('Upload Failed', 'Error uploading image', 'error');
            });
        }
    });
</script>
{% endblock %}
