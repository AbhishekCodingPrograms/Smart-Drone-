{% extends "base.html" %}

{% block title %}Dashboard | Smart Farming Drones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    :root {
        --bg: #0f172a;
        --text: #e9ecef;
        --card-bg: #1e293b;
        --muted: #94a3b8;
        --accent: #10b981;
        --shadow: rgba(0,0,0,0.35);
    }
    
    body {
        background-color: var(--bg);
        font-family: 'Inter', 'Segoe UI', sans-serif;
        color: var(--text);
        transition: background-color 0.3s, color 0.3s;
        min-height: 100vh;
    }
    
    .dashboard-wrapper {
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden;
        padding-top: 0;
    }
    
    .card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        background-color: var(--card-bg);
        box-shadow: 0 4px 6px var(--shadow);
        margin-bottom: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px var(--shadow);
        border-color: rgba(16, 185, 129, 0.3);
    }
    
    .card-header {
        background: linear-gradient(135deg, #10b981, #14b8a6);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600;
        padding: 12px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-online { background-color: #10b981; }
    .status-warning { background-color: #f59e0b; }
    .status-offline { background-color: #ef4444; }
    
    .metric-card {
        text-align: center;
        padding: 20px;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--accent);
    }
    
    .metric-label {
        color: var(--muted);
        font-size: 0.9rem;
    }
    
    .progress {
        height: 10px;
        background-color: var(--bg);
        border-radius: 5px;
        margin-top: 10px;
    }
    
    .progress-bar {
        background-color: var(--accent);
    }
    
    .alert-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 8px;
        border-left: 4px solid;
        background-color: var(--card-bg);
    }
    
    .alert-warning {
        border-left-color: #ffc107;
    }
    
    .alert-danger {
        border-left-color: #dc3545;
    }
    
    .alert-success {
        border-left-color: #10b981;
    }
    
    .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 8px 16px;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background-color: var(--accent);
        border-color: var(--accent);
    }
    
    .btn-primary:hover {
        background-color: #059669;
        border-color: #047857;
    }
    
    .btn-outline {
        border: 1px solid var(--accent);
        color: var(--accent);
    }
    
    .btn-outline:hover {
        background-color: var(--accent);
        color: white;
    }
    
    /* Additional styling for better appearance */
    .container-fluid {
        padding-left: 20px;
        padding-right: 20px;
        width: 100%;
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Fix row overflow */
    .row {
        margin-left: -10px;
        margin-right: -10px;
    }
    
    .row > * {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .badge {
        font-weight: 600;
        padding: 6px 12px;
    }
    
    .list-group-flush .alert-item:first-child {
        border-radius: 12px 12px 0 0;
    }
    
    .list-group-flush .alert-item:last-child {
        border-radius: 0 0 12px 12px;
    }
    
    /* Plotly chart styling */
    .js-plotly-plot {
        background: transparent !important;
    }
    
    /* Map container */
    .map-container {
        position: relative;
        width: 100%;
        height: 400px;
        border-radius: 10px;
        overflow: hidden;
        max-width: 100%;
    }
    
    #map {
        height: 100%;
        width: 100%;
        max-width: 100%;
    }
    
    /* Leaflet map fix */
    .leaflet-container {
        width: 100%;
        height: 100%;
        max-width: 100%;
    }
    
    /* Chart containers */
    .chart-container {
        position: relative;
        width: 100%;
        min-height: 300px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .container-fluid {
            max-width: 100%;
            padding-left: 20px;
            padding-right: 20px;
        }
    }
    
    @media (max-width: 991px) {
        .col-lg-8, .col-lg-4 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .row {
            margin-left: -10px;
            margin-right: -10px;
        }
        
        .card {
            margin-bottom: 20px;
        }
        
        .map-container {
            height: 350px;
            max-width: 100%;
        }
        
        .chart-container {
            min-height: 250px;
            max-width: 100%;
        }
        
        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }
    }
    
    @media (max-width: 768px) {
        .card {
            margin-bottom: 15px;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .card-header {
            padding: 10px 15px;
            font-size: 0.95rem;
        }
        
        .btn {
            font-size: 0.875rem;
            padding: 6px 12px;
        }
        
        .map-container {
            height: 300px;
        }
        
        .hero-stats {
            flex-direction: column;
            gap: 15px;
        }
        
        .d-flex.gap-2 {
            gap: 0.5rem !important;
        }
        
        .d-grid.gap-2 {
            gap: 0.75rem !important;
        }
    }
    
    @media (max-width: 576px) {
        .container-fluid {
            padding-left: 12px;
            padding-right: 12px;
            max-width: 100%;
        }
        
        .row {
            margin-left: -6px;
            margin-right: -6px;
        }
        
        .row > * {
            padding-left: 6px;
            padding-right: 6px;
        }
        
        .card {
            border-radius: 10px;
            margin-bottom: 12px;
            max-width: 100%;
        }
        
        .card-header {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .card-body {
            padding: 12px;
        }
        
        .metric-value {
            font-size: 1.25rem;
        }
        
        .metric-label {
            font-size: 0.8rem;
        }
        
        .btn {
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        .btn-sm {
            font-size: 0.75rem;
            padding: 4px 8px;
        }
        
        .map-container {
            height: 250px;
            max-width: 100%;
        }
        
        .chart-container {
            min-height: 200px;
            max-width: 100%;
        }
        
        .d-none.d-md-inline {
            display: none !important;
        }
    }
    
    @media (max-width: 400px) {
        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
            max-width: 100%;
        }
        
        .card-header {
            font-size: 0.85rem;
        }
        
        .metric-value {
            font-size: 1.1rem;
        }
        
        .card-body {
            padding: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
<div class="container-fluid py-3 py-md-4">
    <!-- Status Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                <div class="card-body d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-online me-2" id="connectionStatus"></span>
                        <span id="lastUpdate" style="color: var(--accent); font-weight: 500;">Connecting to drone telemetry...</span>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge" style="background: var(--accent); font-size: 0.85rem;">Live</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Mission Control -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-rocket me-2"></i>Mission Control
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-success me-2" id="missionStatus">Ready</span>
                            <span class="text-muted" id="missionTimer">Elapsed: 00:00:00</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success me-2" id="startMission">
                                <i class="fas fa-play me-1"></i> Start Mission
                            </button>
                            <button class="btn btn-sm btn-danger" id="stopMission" disabled>
                                <i class="fas fa-stop me-1"></i> Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
            
            <!-- Field Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-area me-2"></i>Field Analysis
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="ndviValue">0.82</div>
                                <div class="metric-label">Avg. NDVI</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar" style="width: 82%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="moistureValue">68%</div>
                                <div class="metric-label">Soil Moisture</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar" style="width: 68%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="metric-card">
                                <div class="metric-value" id="healthValue">89%</div>
                                <div class="metric-label">Crop Health</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" style="width: 89%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div id="healthChart" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Drone Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-drone me-2"></i>Drone Status
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Battery Level</span>
                            <span id="batteryLevel">87%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" style="width: 87%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Signal Strength</span>
                            <span id="signalStrength">Excellent</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-info" style="width: 95%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Storage</span>
                            <span id="storageUsed">64GB / 128GB</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-warning" style="width: 50%"></div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info p-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        <small>Last updated: <span id="lastDroneUpdate">Just now</span></small>
                    </div>
                </div>
            </div>
            
            <!-- Alerts -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-bell me-2"></i>Alerts
                    <span class="badge bg-danger ms-2" id="alertCount">3</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="alertsContainer">
                        <div class="alert-item alert-warning px-3 py-2">
                            <div class="d-flex justify-content-between">
                                <strong>Low Battery Warning</strong>
                                <small class="text-muted">2 min ago</small>
                            </div>
                            <p class="mb-0 small">Battery level below 20%</p>
                        </div>
                        <div class="alert-item alert-success px-3 py-2">
                            <div class="d-flex justify-content-between">
                                <strong>Mission Complete</strong>
                                <small class="text-muted">15 min ago</small>
                            </div>
                            <p class="mb-0 small">Field scan completed successfully</p>
                        </div>
                        <div class="alert-item alert-danger px-3 py-2">
                            <div class="d-flex justify-content-between">
                                <strong>Connection Lost</strong>
                                <small class="text-muted">1 hour ago</small>
                            </div>
                            <p class="mb-0 small">Regained connection to drone</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="captureImage">
                            <i class="fas fa-camera me-2"></i>Capture Image
                        </button>
                        <button class="btn btn-outline-primary" id="generateReport">
                            <i class="fas fa-file-alt me-2"></i>Generate Report
                        </button>
                        <button class="btn btn-outline-secondary" id="calibrateSensors">
                            <i class="fas fa-tools me-2"></i>Calibrate Sensors
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line me-2"></i>Field Analytics
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <div id="analyticsChart" style="width: 100%; height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> <!-- End Container -->
</div> <!-- End Dashboard Wrapper -->
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialize map
    let map = L.map('map').setView([51.505, -0.09], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add a sample marker
    L.marker([51.5, -0.09]).addTo(map)
        .bindPopup('Field 1')
        .openPopup();
    
    // Sample chart data
    const healthData = {
        x: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        y: [86, 88, 84, 89, 87, 90, 89],
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#10b981', width: 3 },
        marker: { color: '#10b981', size: 8 }
    };
    
    const layout = {
        margin: { t: 0, b: 20, l: 40, r: 20 },
        showlegend: false,
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        yaxis: { range: [0, 100] },
        xaxis: { showgrid: false },
        yaxis: { gridcolor: 'rgba(0,0,0,0.05)' }
    };
    
    // Initialize chart
    Plotly.newPlot('healthChart', [healthData], layout);
    
    // Theme is now handled by base.html - removed redundant theme toggle
    
    // Mission control handlers
    document.getElementById('startMission').addEventListener('click', function() {
        // Add your mission start logic here
        document.getElementById('missionStatus').textContent = 'In Progress';
        document.getElementById('missionStatus').className = 'badge bg-warning';
        document.getElementById('stopMission').disabled = false;
        this.disabled = true;
        startMissionTimer();
    });
    
    document.getElementById('stopMission').addEventListener('click', function() {
        // Add your mission stop logic here
        document.getElementById('missionStatus').textContent = 'Completed';
        document.getElementById('missionStatus').className = 'badge bg-success';
        document.getElementById('startMission').disabled = false;
        this.disabled = true;
        stopMissionTimer();
    });
    
    // Mission timer
    let missionStartTime;
    let missionTimer;
    
    function startMissionTimer() {
        missionStartTime = new Date();
        missionTimer = setInterval(updateMissionTimer, 1000);
    }
    
    function stopMissionTimer() {
        clearInterval(missionTimer);
    }
    
    function updateMissionTimer() {
        const now = new Date();
        const diff = now - missionStartTime;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        document.getElementById('missionTimer').textContent = 
            `Elapsed: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Other button handlers
    document.getElementById('captureImage').addEventListener('click', function() {
        showNotification('Image captured successfully!', 'success');
    });
    
    document.getElementById('generateReport').addEventListener('click', function() {
        showNotification('Generating report...', 'info');
        // Add report generation logic here
    });
    
    document.getElementById('calibrateSensors').addEventListener('click', function() {
        showNotification('Calibrating sensors...', 'info');
        // Add calibration logic here
    });
    
    // Notification function
    function showNotification(message, type = 'info') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
        alert.role = 'alert';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 5000);
    }
    
    // Update last updated time
    function updateLastUpdated() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('lastUpdate').textContent = `Last updated: ${timeString}`;
    }
    
    // Update time every minute
    updateLastUpdated();
    setInterval(updateLastUpdated, 60000);
    
    // Initialize map if element exists
    const mapElement = document.getElementById('map');
    if (mapElement) {
        let map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add a marker
        L.marker([51.5, -0.09]).addTo(map)
            .bindPopup('Field Location')
            .openPopup();
    }
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
{% endblock %}
